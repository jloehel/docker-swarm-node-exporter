name: Release Build

on:
  release:
    types: [published]

env:
  IMAGE_NAME: swarm-node-exporter
  REGISTRY_GHCR: ghcr.io
  REGISTRY_DOCKER: docker.io

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Get release tag
        id: release
        run: |
          # Tag format: <node_exporter_version>-<build>
          # Example: 1.10.2-1
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG%-*}"
          BUILD="${TAG##*-}"
          {
            echo "tag=${TAG}"
            echo "version=${VERSION}"
            echo "build=${BUILD}"
          } >> "$GITHUB_OUTPUT"
          echo "Release tag: ${TAG}, Version: ${VERSION}, Build: ${BUILD}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          build-args: |
            NODE_EXPORTER_VERSION=${{ steps.release.outputs.version }}
          tags: |
            ${{ env.REGISTRY_GHCR }}/jloehel/${{ env.IMAGE_NAME }}:${{ steps.release.outputs.tag }}
            ${{ env.REGISTRY_GHCR }}/jloehel/${{ env.IMAGE_NAME }}:${{ steps.release.outputs.version }}
            ${{ env.REGISTRY_GHCR }}/jloehel/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY_DOCKER }}/jloehel/${{ env.IMAGE_NAME }}:${{ steps.release.outputs.tag }}
            ${{ env.REGISTRY_DOCKER }}/jloehel/${{ env.IMAGE_NAME }}:${{ steps.release.outputs.version }}
            ${{ env.REGISTRY_DOCKER }}/jloehel/${{ env.IMAGE_NAME }}:latest

      - name: Update README with new version
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          VERSION="${{ steps.release.outputs.version }}"
          BUILD="${{ steps.release.outputs.build }}"

          # Update Dockerfile example
          sed -i "s/NODE_EXPORTER_VERSION=[0-9.]\+/NODE_EXPORTER_VERSION=${VERSION}/g" README.md
          sed -i "s/swarm-node-exporter:[0-9.]\+-[0-9]\+/swarm-node-exporter:${TAG}/g" README.md

          # Check if tag already in supported tags table
          if ! grep -q "| \`${TAG}\`" README.md; then
            # Add new tag row after the header row
            sed -i "/| \`latest\` /a | \`${TAG}\` | node-exporter ${VERSION}, build ${BUILD} |" README.md
          fi

          # Update version-only tag
          sed -i "s/| \`[0-9.]\+\` | Specific node-exporter version/| \`${VERSION}\` | Specific node-exporter version/g" README.md

      - name: Commit README changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --staged --quiet || git commit -m "docs: update README for release ${{ steps.release.outputs.tag }}"
          git push
